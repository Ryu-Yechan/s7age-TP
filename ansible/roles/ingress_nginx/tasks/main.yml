- name: Check helm exists
  command: helm version
  changed_when: false

- name: Add ingress-nginx Helm repo
  shell: helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx || true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Update Helm repos
  shell: helm repo update
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    
- name: Create ingress-nginx namespace
  shell: kubectl create namespace ingress-nginx --dry-run=client -o yaml | kubectl apply -f -
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Install ingress-nginx (NodePort)
  shell: |
    helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
      -n ingress-nginx \
      --set controller.service.type=NodePort \
      --set controller.service.nodePorts.http=30080 \
      --set controller.service.nodePorts.https=30443
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml 