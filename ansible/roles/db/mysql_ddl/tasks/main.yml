- name: Wait for MySQL to be ready
  shell: |
    kubectl exec -n {{ mysql_namespace }} mysql-0 -- mysqladmin ping -u root -p'{{ mysql_root_password }}' --silent
  register: mysql_ready
  until: mysql_ready.rc == 0
  retries: 30
  delay: 10
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Copy init.sql to master
  copy:
    src: init.sql
    dest: /tmp/init.sql
    mode: "0644"

- name: Create stage user and grant privileges
  shell: |
    kubectl exec -n {{ mysql_namespace }} mysql-0 -- \
      mysql -u root -p'{{ mysql_root_password }}' -e "
        CREATE USER IF NOT EXISTS '{{ mysql_user }}'@'%' IDENTIFIED BY '{{ mysql_password }}';
        GRANT ALL PRIVILEGES ON {{ mysql_database }}.* TO '{{ mysql_user }}'@'%';
        FLUSH PRIVILEGES;
      "
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Copy init.sql to MySQL pod
  shell: kubectl cp /tmp/init.sql mysql/mysql-0:/tmp/init.sql
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Initialize database tables
  shell: |
    kubectl exec -n {{ mysql_namespace }} mysql-0 -- \
      mysql -u root -p'{{ mysql_root_password }}' {{ mysql_database }} -e "source /tmp/init.sql"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"